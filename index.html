<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íœ˜ë§¤ì“° DB</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #4CAF50;
      color: white;
      text-align: center;
      padding: 1em 0;
    }
    main {
      padding: 20px;
    }
    .filter-section {
      margin: 20px 0;
      text-align: center;
    }
    .filter-section input {
      padding: 5px;
      margin-left: 5px;
    }
    #game-details {
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    /* ì ìˆ˜ ì—´ ë„ˆë¹„ ì„¤ì • */
    table th:nth-child(3),
    table td:nth-child(3) {
      width: 90px; /* ì ìˆ˜ ì—´ ë„ˆë¹„ 60% ìˆ˜ì¤€ìœ¼ë¡œ ê°ì†Œ */
    }
    table th {
      background-color: #f2f2f2;
    }
    .export-button {
      margin-top: 20px;
      text-align: center;
    }
    .export-button button {
      padding: 10px 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .export-button button:hover {
      background-color: #0056b3;
    }
    .export-button img {
      width: 16px;
      height: 16px;
      margin-right: 5px;
      vertical-align: middle;
    }
    .delete-btn {
      background-color: #ff4d4d;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
    }
    .delete-btn:hover {
      background-color: #ff0000;
    }
    /* ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 300px;
      border-radius: 5px;
      text-align: center;
    }
    .modal-buttons {
      margin-top: 20px;
    }
    .modal-buttons button {
      padding: 8px 16px;
      margin: 0 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .confirm-delete {
      background-color: #ff4d4d;
      color: white;
    }
    .cancel-delete {
      background-color: #ccc;
    }
  </style>
  <!-- xlsx, FileSaver.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
  
  <script defer>
    let gameData = [];
    let userData = [];
    let selectedGame = '';
    let selectedUser = '';
    let recordToDelete = null; // ì‚­ì œí•  ë ˆì½”ë“œ ì €ì¥ìš© ë³€ìˆ˜

    // ì •ë ¬ìš© ì „ì—­ ë³€ìˆ˜
    let sortKey = '';
    let sortDirection = 'desc'; // ê¸°ë³¸ ë‚´ë¦¼ì°¨ìˆœ

    // âœ… APIë¡œ ê²Œì„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function fetchGameData(page = 1, pageSize = 1000000) {
      try {
        const response = await fetch(`https://us-central1-record-f420d.cloudfunctions.net/getGameData?page=${page}&pageSize=${pageSize}`);
        const result = await response.json();
        console.log('ê²Œì„ API ì‘ë‹µ:', result);

        if (result.data && Array.isArray(result.data)) {
          gameData = result.data;
          removeDuplicates();
          renderGameDatalist();
          renderFilteredDetails();
        } else {
          console.warn('ì˜ˆìƒì¹˜ ëª»í•œ ê²Œì„ ë°ì´í„° í˜•ì‹ ë°˜í™˜:', result);
        }
      } catch (error) {
        console.error('ê²Œì„ API í˜¸ì¶œ ì˜¤ë¥˜:', error);
      }
    }

    // âœ… ì¤‘ë³µ ë°ì´í„° ì œê±°
    function removeDuplicates() {
      const uniqueData = [];
      const seen = new Set();

      for (let i = gameData.length - 1; i >= 0; i--) {
        const { name, score, elapsedTime } = gameData[i];
        const identifier = `${name}-${score}-${elapsedTime}`;
        if (!seen.has(identifier)) {
          seen.add(identifier);
          uniqueData.unshift(gameData[i]);
        }
      }

      gameData = uniqueData;
    }

    // âœ… APIë¡œ ì‚¬ìš©ì ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function fetchUserData(page = 1, pageSize = 1000000) {
      try {
        const response = await fetch(`https://us-central1-record-f420d.cloudfunctions.net/getUserData?page=${page}&pageSize=${pageSize}`);
        const result = await response.json();
        console.log('ì‚¬ìš©ì API ì‘ë‹µ:', result);

        if (result.data && Array.isArray(result.data)) {
          userData = result.data;
          renderUserDatalist();
          renderFilteredDetails();
        } else {
          console.warn('ì˜ˆìƒì¹˜ ëª»í•œ ì‚¬ìš©ì ë°ì´í„° í˜•ì‹ ë°˜í™˜:', result);
        }
      } catch (error) {
        console.error('ì‚¬ìš©ì API í˜¸ì¶œ ì˜¤ë¥˜:', error);
      }
    }

    // âœ… ê²Œì„ datalist ë Œë”ë§
    function renderGameDatalist() {
      const datalist = document.getElementById('game-list');
      // ê³ ìœ  ê²Œì„ëª… ì¶”ì¶œ
      let uniqueGames = Array.from(new Set(gameData.map(item => item.game)));
      // ì‚¬ìš©ìê°€ ì„ íƒëœ ê²½ìš° ì‚¬ì „ì‹ ì •ë ¬
      if (selectedUser) {
        uniqueGames.sort();
      }
      datalist.innerHTML = '';
      uniqueGames.forEach(game => {
        const option = document.createElement('option');
        option.value = game;
        datalist.appendChild(option);
      });
    }

    // âœ… ì‚¬ìš©ì datalist ë Œë”ë§
    function renderUserDatalist() {
      const datalist = document.getElementById('user-list');
      let uniqueUsers = Array.from(new Set(userData.map(item => item.name)));
      uniqueUsers.sort(); // í•­ìƒ ì‚¬ì „ì‹ ì •ë ¬
      datalist.innerHTML = '';
      uniqueUsers.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        datalist.appendChild(option);
      });
    }

    // âœ… ê²Œì„ ì„ íƒ ì…ë ¥ í•¸ë“¤ëŸ¬
    function handleGameInput() {
      selectedGame = document.getElementById('game-input').value;
      // ê²Œì„ ì„ íƒ ì‹œ ì‚¬ìš©ì ì„ íƒ ì´ˆê¸°í™”
      selectedUser = '';
      document.getElementById('user-input').value = '';
      renderFilteredDetails();
    }

    // âœ… ì‚¬ìš©ì ì„ íƒ ì…ë ¥ í•¸ë“¤ëŸ¬
    function handleUserInput() {
      selectedUser = document.getElementById('user-input').value;
      // ì‚¬ìš©ì ì„ íƒ ì‹œ ê²Œì„ ì„ íƒ ì´ˆê¸°í™”
      selectedGame = '';
      document.getElementById('game-input').value = '';
      renderFilteredDetails();
      // ì‚¬ìš©ì ì„ íƒì— ë”°ë¼ ê²Œì„ ëª©ë¡ì€ ì‚¬ì „ì‹ ì •ë ¬
      renderGameDatalist();
    }

    // âœ… ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    function sortData(key, direction = 'desc') {
      sortKey = key;
      sortDirection = direction;
      renderFilteredDetails();  // ì •ë ¬ í›„ ë‹¤ì‹œ ë Œë”ë§
    }

    // âœ… ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    function showDeleteConfirmation(game, name, timestamp) {
      // ì‚­ì œí•  ë ˆì½”ë“œ ì •ë³´ ì €ì¥
      recordToDelete = { game, name, timestamp };
      
      // ëª¨ë‹¬ í‘œì‹œ
      document.getElementById('deleteModal').style.display = 'block';
    }

    // âœ… ì‚­ì œ í™•ì¸ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    async function confirmDelete() {
      if (!recordToDelete) return;
      
      try {
        // DELETE ìš”ì²­ ìƒì„±
        const { game, name, timestamp } = recordToDelete;
        const response = await fetch(
          `https://us-central1-record-f420d.cloudfunctions.net/deleteData?game=${encodeURIComponent(game)}&name=${encodeURIComponent(name)}&timestamp=${timestamp}`,
          { method: 'DELETE' }
        );
        
        const result = await response.json();
        
        if (result.success) {
          // ì„±ê³µì ìœ¼ë¡œ ì‚­ì œëœ ê²½ìš° ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
          alert('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          await fetchGameData();
          await fetchUserData();
        } else {
          alert(`ì‚­ì œ ì‹¤íŒ¨: ${result.message}`);
        }
      } catch (error) {
        console.error('ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
        alert('ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        // ëª¨ë‹¬ ìˆ¨ê¸°ê¸° ë° ì‚­ì œ ë ˆì½”ë“œ ì •ë³´ ì´ˆê¸°í™”
        closeDeleteModal();
      }
    }

    // âœ… ì‚­ì œ ì·¨ì†Œ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
      recordToDelete = null;
    }

    // âœ… í†µí•© í•„í„°ë§ ë° ë Œë”ë§ í•¨ìˆ˜
    function renderFilteredDetails() {
      let filteredData = gameData;

      if (selectedGame) {
        filteredData = filteredData.filter(item => item.game === selectedGame);
      }
      if (selectedUser) {
        filteredData = filteredData.filter(item => item.name === selectedUser);
      }

      // ì •ë ¬ ë¡œì§
      if (sortKey) {
        filteredData.sort((a, b) => {
          let aVal, bVal;

          switch (sortKey) {
            case 'game':
              aVal = a.game;
              bVal = b.game;
              break;
            case 'name':
              aVal = a.name;
              bVal = b.name;
              break;
            case 'timePerProblem':
              const aTime = (Number(a.elapsedTime) / Number(a.score)) * 10 || 0;
              const bTime = (Number(b.elapsedTime) / Number(b.score)) * 10 || 0;
              aVal = aTime;
              bVal = bTime;
              break;
            case 'timestamp':
              aVal = a.timestamp;
              bVal = b.timestamp;
              break;
            default:
              aVal = a[sortKey];
              bVal = b[sortKey];
              break;
          }

          // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
          if (sortDirection === 'desc') {
            if (aVal > bVal) return -1;
            if (aVal < bVal) return 1;
            return 0;
          } else {
            // í˜¹ì‹œ ë‹¤ë¥¸ ë°©í–¥ ì •ë ¬ì„ ì¶”ê°€í•  ê²½ìš° ëŒ€ë¹„(asc ë“±)
            if (aVal < bVal) return -1;
            if (aVal > bVal) return 1;
            return 0;
          }
        });
      }

      const tbody = document.getElementById('data-body');
      tbody.innerHTML = '';

      filteredData.forEach((item) => {
        // ë¬¸ì œë‹¹ ì†Œìš”ì‹œê°„ ê³„ì‚°: (ê²½ê³¼ì‹œê°„ Ã· ì ìˆ˜) Ã— 10
        let timePerProblem = 0;
        if (item.score && item.score !== 0) {
          timePerProblem = (Number(item.elapsedTime) / Number(item.score)) * 10;
        }

        const tr = document.createElement('tr');

        // ê²Œì„ ì…€
        const gameTd = document.createElement('td');
        gameTd.innerHTML = `<a href="#" onclick="goToGame('${item.game}')">${item.game}</a>`;

        // ì´ë¦„ ì…€
        const nameTd = document.createElement('td');
        nameTd.innerHTML = `<a href="#" onclick="goToUser('${item.name}')">${item.name}</a>`;

        // ì ìˆ˜
        const scoreTd = document.createElement('td');
        const scoreText = item.maxScore ? `${item.score}/${item.maxScore}` : `${item.score}`;
        scoreTd.textContent = scoreText;

        // ê²½ê³¼ì‹œê°„
        const elapsedTimeTd = document.createElement('td');
        elapsedTimeTd.textContent = item.elapsedTime;

        // ë¬¸ì œë‹¹ ì†Œìš”ì‹œê°„
        const timePerProblemTd = document.createElement('td');
        timePerProblemTd.textContent = timePerProblem.toFixed(2);

        // Timestamp
        const timestampTd = document.createElement('td');
        timestampTd.textContent = new Date(item.timestamp).toLocaleString();

        // ì‚­ì œ ë²„íŠ¼
        const deleteTd = document.createElement('td');
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'X';
        deleteBtn.className = 'delete-btn';
        deleteBtn.onclick = function() {
          showDeleteConfirmation(item.game, item.name, item.timestamp);
        };
        deleteTd.appendChild(deleteBtn);

        tr.appendChild(gameTd);
        tr.appendChild(nameTd);
        tr.appendChild(scoreTd);
        tr.appendChild(elapsedTimeTd);
        tr.appendChild(timePerProblemTd);
        tr.appendChild(timestampTd);
        tr.appendChild(deleteTd); // ì‚­ì œ ë²„íŠ¼ ì…€ ì¶”ê°€

        tbody.appendChild(tr);
      });
    }

    // âœ… ê²Œì„/ì´ë¦„ í´ë¦­ ì‹œ í•„í„°ë§ í•¨ìˆ˜
    function goToGame(game) {
      selectedGame = game;
      document.getElementById('game-input').value = game;
      selectedUser = '';
      document.getElementById('user-input').value = '';
      renderFilteredDetails();
    }

    function goToUser(name) {
      selectedUser = name;
      document.getElementById('user-input').value = name;
      selectedGame = '';
      document.getElementById('game-input').value = '';
      renderFilteredDetails();
    }

    // âœ… ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°
    function exportToExcel() {
      if (!XLSX) {
        console.error('XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }

      // í˜„ì¬ í•„í„°ë§ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      let filteredData = gameData;
      if (selectedGame) {
        filteredData = filteredData.filter(item => item.game === selectedGame);
      }
      if (selectedUser) {
        filteredData = filteredData.filter(item => item.name === selectedUser);
      }

      // ì—‘ì…€ë¡œ ë‚´ë³´ë‚¼ ë°ì´í„° êµ¬ì„±
      const exportData = filteredData.map(item => {
        let timePerProblem = 0;
        if (item.score && item.score !== 0) {
          timePerProblem = (Number(item.elapsedTime) / Number(item.score)) * 10;
        }

        return {
          "ê²Œì„": item.game,
          "ì´ë¦„": item.name,
          "ì ìˆ˜": item.maxScore ? `${item.score}/${item.maxScore}` : `${item.score}`,
          "ê²½ê³¼ì‹œê°„": item.elapsedTime,
          "ë¬¸ì œë‹¹ ì†Œìš”ì‹œê°„": timePerProblem.toFixed(2),
          "Timestamp": new Date(item.timestamp).toLocaleString()
        };
      });

      // ë°ì´í„° ì‹œíŠ¸ ìƒì„±
      const worksheet = XLSX.utils.json_to_sheet(exportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Filtered Data");

      // íŒŒì¼ ì´ë¦„ì„ "íœ˜ë§¤ì“° ì—°ì‚° ì±Œë¦°ì§€.xlsx" ë¡œ ê³ ì •
      const fileName = "íœ˜ë§¤ì“° ì—°ì‚° ì±Œë¦°ì§€.xlsx";
      XLSX.writeFile(workbook, fileName);
    }

    // í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ API ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    window.onload = () => {
      fetchGameData();
      fetchUserData();
    };
  </script>
</head>
<body>
  <header>
    <h1>ğŸ® ê²Œì„ ë° ì‚¬ìš©ì ë°ì´í„° ëŒ€ì‹œë³´ë“œ</h1>
  </header>
  <main>
    <section class="filter-section">
      <!-- ê²Œì„ ì„ íƒ ì…ë ¥ë€ê³¼ datalist -->
      <label for="game-input">ê²Œì„ ì„ íƒ:</label>
      <input type="text" id="game-input" list="game-list" oninput="handleGameInput()">
      <datalist id="game-list"></datalist>

      <!-- ì‚¬ìš©ì ì„ íƒ ì…ë ¥ë€ê³¼ datalist -->
      <label for="user-input">ì‚¬ìš©ì ì„ íƒ:</label>
      <input type="text" id="user-input" list="user-list" oninput="handleUserInput()">
      <datalist id="user-list"></datalist>
    </section>

    <section class="export-button">
      <button onclick="exportToExcel()">
        <img src="https://cdn-icons-png.flaticon.com/512/732/732220.png" alt="Excel Icon"> ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°
      </button>
    </section>

    <section id="game-details">
      <h2>ë°ì´í„° ìƒì„¸ ì •ë³´</h2>
      <table>
        <thead>
          <tr>
            <!-- ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ ë²„íŠ¼ ì¶”ê°€ (â–¼) -->
            <th>
              ê²Œì„ 
              <button onclick="sortData('game', 'desc')">â–¼</button>
            </th>
            <th>
              ì´ë¦„ 
              <button onclick="sortData('name', 'desc')">â–¼</button>
            </th>
            <th>ì ìˆ˜</th>
            <th>ê²½ê³¼ì‹œê°„</th>
            <th>
              ë¬¸ì œë‹¹ ì†Œìš”ì‹œê°„ 
              <button onclick="sortData('timePerProblem', 'desc')">â–¼</button>
            </th>
            <th>
              Timestamp 
              <button onclick="sortData('timestamp', 'desc')">â–¼</button>
            </th>
            <th>ì‚­ì œ</th> <!-- ì‚­ì œ ì—´ ì¶”ê°€ -->
          </tr>
        </thead>
        <tbody id="data-body"></tbody>
      </table>
    </section>
  </main>
  <footer>
    <p>Â© 2024 ê²Œì„ ë° ì‚¬ìš©ì ë°ì´í„° ëŒ€ì‹œë³´ë“œ</p>
  </footer>

  <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3>ë°ì´í„° ì‚­ì œ</h3>
      <p>ì •ë§ë¡œ ì´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <p>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      <div class="modal-buttons">
        <button class="confirm-delete" onclick="confirmDelete()">ì‚­ì œ</button>
        <button class="cancel-delete" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>
</body>
</html>